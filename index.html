<html>
  <head>
    <title>OpenFest</title>

    <meta charset="utf-8">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.2.1/reveal.min.css" integrity="sha512-ZIo9ivf88U0L1S+0D/npMNTTkjez5B9cK5xIecN4IA2OmtbTNBbPAZo/0cBC195sq7FU7cEOVPwtit37f/+1rQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.2.1/theme/black.min.css" integrity="sha512-8xTQdrxFqvj1S4G+pM5d0AwjjKm5vHbi6gZwDX2FDq8HHvfPDf1BEIjBC0fvIh/EFiPeGdDVJZtx66b+4veM9g==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link href="https://fonts.googleapis.com/css2?family=Sofia+Sans+Condensed:ital,wght@0,1..1000;1,1..1000&family=Sofia+Sans:ital,wght@0,1..1000;1,1..1000&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="styles.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.2.1/reveal.min.js" integrity="sha512-lRYVCjdH7dCPCzqLL6eBn78p6WGK5pZxgYBgzTQfWlfX7yiZFLt/qHOMSETHUIz2aZIU/KbjwYHiMsmrcVgJnA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/16.3.0/lib/marked.umd.min.js" integrity="sha512-V6rGY7jjOEUc7q5Ews8mMlretz1Vn2wLdMW/qgABLWunzsLfluM0FwHuGjGQ1lc8jO5vGpGIGFE+rTzB+63HdA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js" integrity="sha512-QoJS4DOhdmG8kbbHkxmB/rtPdN62cGWXAdAFWWJPvUFF1/zxcPSdAnn4HhYZSIlVoLVEJ0LesfNlusgm2bPfnA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/locale/bg.min.js" integrity="sha512-yO+EE07mmW251gz7RW8ih8qhLz9slH0B60GnePsff2FP7hj5KfvyMBSYfmPDsZknqdsJoxBRWgmIadUuUGmP7w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ractive/1.4.4/ractive.min.js" integrity="sha512-XdBEYvgEQ8+dyXVSJ1rl6z/chkpUcaUxzHwv+XiS9DTvPILEOTFDCQ24yWGp1aAct2e1ff/2fXT9CMFmQatLXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
      </div>
    </div>

    <video id="background_video" src="background.mp4" loop autoplay muted />
    <!-- TODO: fix display of speakers -->

    <script id="agenda_template" type="text/ractive">
      <section id="agenda" data-autoslide="10000">
        <h3>{{room}}</h3>
        <table class="reveal">
          <tbody>
            {{#pastEvents}}
            <tr class="past_event">
              <td>{{startTime.format('HH:mm')}}</td>
              <td>{{title}}</td>
              <td>
                {{#persons}}
                  {{public_name}}<br/>
                {{/persons}}
              </td>
            </tr>
            {{/pastEvents}}

            {{#nextEvent}}
            <tr class="next_event">
              <td>{{startTime.format('HH:mm')}}</td>
              <td>{{title}}</td>
              <td>
                {{#persons}}
                  {{public_name}}<br/>
                {{/persons}}
              </td>
            </tr>
            {{/nextEvent}}

            {{#futureEvents}}
            <tr class="future_event">
              <td>{{startTime.format('HH:mm')}}</td>
              <td>{{title}}</td>
              <td>
                {{#persons}}
                  {{public_name}}<br/>
                {{/persons}}
              </td>
            </tr>
            {{/futureEvents}}
          </tbody>
        </table>
      </section>
    </script>

    <script id="current_talk_template" type="text/ractive">
      <section id="current_talk" data-autoslide="10000">
        <h4>В момента</h4>
        <h2>{{currentEvent.title}}</h2>
        <div class="wall">{{{marked(currentEvent.abstract)}}}</div>
      </section>
    </script>

    <script id="speaker_template" type="text/ractive">
      <section data-autoslide="10000">
        <h4>Лектор</h4>
        <h2>{{public_name}}</h2>
        <div class="wall">{{{marked(biography)}}}</div>
      </section>
    </script>

    <script id="next_talk_template" type="text/ractive">
      <section id="next_talk" data-autoslide="10000">
        <h4>Следва</h4>
        <h2>{{nextEvent.title}}</h2>
        <div class="wall">{{{marked(nextEvent.abstract)}}}</div>
        <h5><i>({{nextEvent.startTime.from(now)}})</i></h5>
      </section>
    </script>

    <script id="slides_template" type="text/ractive">
      <section data-state="update-safe" data-autoslide="{{waitTime}}">
        <img src="logo.png">
      </section>

      {{#each events}}
      {{#eventCount}}
        <section>
          {{> agenda_template}}

          {{#currentEvent}}
            {{> current_talk_template}}
          {{/currentEvent}}

          {{#currentEvent.persons}}
            {{> speaker_template}}
          {{/currentEvent.persons}}

          {{#nextEvent}}
            {{> next_talk_template}}
          {{/nextEvent}}

          {{#nextEvent.persons}}
            {{> speaker_template}}
          {{/nextEvent.persons}}
        </section>
      {{/eventCount}}
	  {{/each}}

      <section data-autoslide="5000">
        <h1>#OpenFest2025</h1>
        <h2>в Twitter</h2>
      </section>
    </script>

    <script src="schedule.js"></script>

    <script type="text/javascript">
        const urlParams = new URLSearchParams(document.location.search);

        async function refreshEvent(schedule) {
            await schedule.update();
            return { 
                waitTime: urlParams.get('wait-on-startup') ?? 5000,
                events: schedule.rooms.map(r => ({
                    pastEvents: r.pastEvents(),
                    currentEvent: r.currentEvent(),
                    nextEvent: r.nextEvent(),
                    futureEvents: r.futureEvents(),
                    eventCount: r.allEvents().length,
                    now: r.now(),
                    room: r.roomName()
                })),
            };
        }

        window.onload = () => {
            const schedule = new Schedule(
                urlParams.get("room"),
                urlParams.get("date"),
                urlParams.get('now') ? () => moment(urlParams.get('now')) : undefined,
            );

            const helpers = Ractive.defaults.data;
            helpers.marked = x => x ? marked.parse(x) : '';

            refreshEvent(schedule).then(d => {
                const reactive = new Ractive({
                    el: '.slides',
                    template: '#slides_template',
                    data: d,
                });

                Reveal.initialize({
                    controls: false,
                    progress: false,
                    loop: true,
                    autoSlide: true,
                    autoSlideStoppable: true, // needed to hide the play button
                    width: 1920,
                    height: 1080,
                    margin: 0.1,
                    minScale: 0.2,
                    maxScale: 5.0,
                });

                Reveal.on('update-safe', async () => await refreshEvent(schedule).then(d => reactive.set(d)));
            });
        }
    </script>
    <script type="text/javascript">
        //  use for green screen background
        if (urlParams.get('background')) {
            document.querySelector('body').style.backgroundColor = urlParams.get('background');
        }
    </script>
  </body>
</html>
